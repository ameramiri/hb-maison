{% extends 'base.html' %}
{% load static %}
{% load format_filters %}

{% block title %}Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§{% endblock %}

{% block content %}
<h2>Ù„ÛŒØ³Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h2>

<style>
  .filters-row input,
  .filters-row select {
    font-size: 13px;
    width: 100%;
    height: 24px;
    box-sizing: border-box;
    padding: 2px 4px;
  }

  .date-filter-fields {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 1px 4px;
    gap: 0px;
  }

  .date-filter-fields:focus-within {
    border-color: #000000;
    border-width: 2px;
    padding: 0 3px;
  }

  .date-filter-fields input {
    width: 25px;
    height: 24px;
    text-align: center;
    font-size: 13px;
    border: none;
    outline: none;
    background: transparent;
    direction: ltr;
  }

  .date-filter-fields input#id_year_input {
    width: 33px;
  }

  .date-filter-fields span {
    color: #999;
    font-weight: bold;
    user-select: none;
    font-size: 13px;
  }

  /* Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ø¨Ø§ zoom */
  .date-filter-fields input::-webkit-outer-spin-button,
  .date-filter-fields input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

</style>

<form method="get" id="filters-in-header">
  <div id="scroll-box" class="table-wrap" style="height:500px; overflow-y:auto;">
    <table class="table-pro">
      <thead>
        <tr>
          <th>ØªØ§Ø±ÛŒØ®</th>
          <th>Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª</th>
          <th>Ø·Ø±Ù Ø­Ø³Ø§Ø¨</th>
          <th>Ú©Ø§Ù„Ø§</th>
          <th>ØªØ¹Ø¯Ø§Ø¯</th>
          <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
          <th>Ù…Ø¨Ù„Øº Ú©Ù„</th>
          <th>Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡</th>
          <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
        </tr>

        <!-- ğŸ”½ Ø³Ø·Ø± ÙÛŒÙ„ØªØ± -->
        <tr class="filters-row">
          <th>
            <div class="date-filter-fields">
              {{ form.day_input }}/
              {{ form.month_input }}/
              {{ form.year_input }}
            </div>
          </th>
          <th>{{ form.op_type }}</th>
          <th>{{ form.party }}</th>
          <th>{{ form.item }}</th>
          <th>{{ form.qty }}</th>
          <th>{{ form.unit_price }}</th>
          <th>{{ form.total_price }}</th>
          <th>{{ form.cogs }}</th>
          <th>{{ form.description }}</th>
        </tr>
      </thead>
      <tbody id="tx-body" data-last-id="{{ transactions_last_id }}">
        {% include "ledger/partials/tx_rows.html" with transactions=transactions %}
      </tbody>
    </table>
  </div>
</form>

<input type="hidden" id="prev-page" value="{{ previous_page|default:'' }}">

{% endblock %}

{% block scripts %}
<script src="{% static 'js/modals.js' %}"></script>

<script>

document.addEventListener('DOMContentLoaded', function(){
  // --- Select2 ---
  if (window.jQuery) {
    $(document).on('select2:open', () => {
      // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ú©Ø³ Ø³Ø±Ú† Select2 Ùˆ ÙÙˆÚ©ÙˆØ³ Ø¯Ø§Ø¯Ù† Ø¨Ù‡Ø´
      let searchBox = document.querySelector('.select2-container--open .select2-search__field');
      if (searchBox) {
        searchBox.focus();
      }
    });

    $('#id_op_type').select2({ width:'100px', dir:'rtl', minimumResultsForSearch: Infinity }).on('select2:select select2:clear', () => form.requestSubmit());    
    $('#id_item'   ).select2({ width:'172px', dir:'rtl' }).on('select2:select select2:clear', () => form.requestSubmit());
    $('#id_party'  ).select2({ width:'172px', dir:'rtl' }).on('select2:select select2:clear', () => form.requestSubmit());
  }

  // --- ÙØ±Ù… ÙÛŒÙ„ØªØ± ---
  const form = document.querySelector('#filters-in-header');
  if (form) {
    const autoSubmit = (() => {
      let t = null;
      return (delay = 120) => { clearTimeout(t); t = setTimeout(() => form.requestSubmit(), delay); };
    })();

    const ids = ['id_op_type', 'id_item', 'id_party', 'id_day_input', 'id_month_input', 'id_year_input'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;

      // Ø¨Ø±Ø§ÛŒ selectÙ‡Ø§ â†’ select2 event
      if (window.jQuery && jQuery(el).data('select2')) {
        jQuery(el).on('select2:select select2:clear', () => autoSubmit(0));
      }
    });

    const dateInput = document.getElementById('id_date_shamsi');
    const isFullDate = s => /^\d{4}\/\d{2}\/\d{2}$/.test(s);

    if (dateInput) {
      dateInput.value = toFa(dateInput.value);
      dateInput.addEventListener('input', () => {
        dateInput.value = toFa(dateInput.value);
        const valEn = toEn(dateInput.value.replace(/-/g,'/').trim());
        if (isFullDate(valEn)) autoSubmit();
      });
      dateInput.addEventListener('change', () => autoSubmit(0));
      dateInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); autoSubmit(0); }});
    }

    // --- Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ø¨Ø§ Enter ---
    form.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          localStorage.setItem('lastFocusedField', el.id);
          autoSubmit(0);
        }
      });
    });

    // --- Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† ÙÙˆÚ©ÙˆØ³ Ù¾Ø³ Ø§Ø² reload ---
    const lastFocused = localStorage.getItem('lastFocusedField');
    if (lastFocused) {
      const field = document.getElementById(lastFocused);
      if (field) {
        setTimeout(() => field.focus(), 200);
      }
      localStorage.removeItem('lastFocusedField');
    }
  }

  const dayInput   = setupNumericField('id_day_input', 0);
  const monthInput = setupNumericField('id_month_input', 0);
  const yearInput  = setupNumericField('id_year_input', 0);
  const qty        = setupNumericField('id_qty', 0);
  const unitPrice  = setupNumericField('id_unit_price', 0);
  const totalPrice = setupNumericField('id_total_price', 0);
  const cogs       = setupNumericField('id_cogs', 0);

  // --- Infinite scroll ---
  const box = document.getElementById("scroll-box");
  const body = document.getElementById("tx-body");
  let loading = false;
  let lastId = body.dataset.lastId;

  box.addEventListener("scroll", async function() {
    const nearBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 10;
    if (nearBottom && !loading && lastId) {
      loading = true;
      try {
        const url = new URL(window.location.href);
        url.searchParams.set("last_id", lastId);

        const res = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await res.json();

        body.insertAdjacentHTML("beforeend", data.html); // ğŸ‘ˆ Ø§Ø¶Ø§ÙÙ‡ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
        lastId = data.last_id;
        if (!data.has_more) lastId = null;
      } catch (err) {
        console.error("Ajax error", err);
      }
      loading = false;
    }
  });
});
</script>
{% endblock %}
