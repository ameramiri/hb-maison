{% extends 'base.html' %}
{% load format_filters %}

{% block title %}مدیریت کالاها{% endblock %}

{% block content %}
  <h2>مدیریت کالاها</h2>

  <style>
    .icon-btn{ border:1px solid #d0d5dd; background:#f9fafb; border-radius:8px; padding:6px 8px; cursor:pointer; }
    .icon-btn:hover{ background:#eef2f7; }
    /* رفع مشکل نمایش منوی select2 روی مودال */
    .select2-container--open { z-index: 3000 !important; }
    .select2-dropdown { z-index: 3050 !important; }
  </style>

<form method="get" class="filter-form"
      style="display:flex; flex-wrap:wrap; gap:.75rem; align-items:center;">
  <div style="display:flex; flex-direction:row; align-items:center; gap:.5rem; margin-bottom:.5rem;">
    <input type="text" name="q" value="{{ q }}"
      placeholder="جستجو در نام کالا…"
      style="padding:.4rem .6rem; width:200px;"
      onkeydown="if(event.key==='Enter'){ this.form.submit(); }">
  <button type="button" class="btn-add-item icon-btn"
          data-url="/item/create/"
          data-table="items-table-wrap" 
          data-success="کالا با موفقیت اضافه شد">➕</button>
  </div>

  <div style="display:flex; flex-direction:column; gap:.5rem; flex-basis:100%; margin-top:.25rem;">

    <!-- خط اول -->
    <div style="display:flex; align-items:center; gap:1rem;">
      <label style="display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; min-width:100px;">
        <input id="exclude_zero" type="checkbox" name="exclude_zero"
               {% if exclude_zero %}checked{% endif %}
               style="margin:0; width:16px; height:16px; cursor:pointer;"
               onchange="this.form.submit();">
        فقط موجودی دارها
      </label>
      <div class="totals-bar-single">
        <span class="label"><strong>ارزش فروش موجودی:</strong></span>
        <span class="value" dir="ltr">{{ totals.sum_sales|fa_thousand }}</span>
      </div>
    </div>

    <!-- خط دوم -->
    <div style="display:flex; align-items:center; gap:1rem;">
      <label style="display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; min-width:100px;">
        <input id="only_consignment" type="checkbox" name="only_consignment"
               {% if only_consignment %}checked{% endif %}
               style="margin:0; width:16px; height:16px; cursor:pointer;"
               onchange="this.form.submit();">
        فقط کالاهای امانی
      </label>
      <div class="totals-bar-single">
        <span class="label"><strong>ارزش خرید موجودی:</strong></span>
        <span class="value" dir="ltr">{{ totals.sum_inventory|fa_thousand }}</span>
      </div>
    </div>

  </div>

</form>

  <!-- لیست کالاها -->
  <div id="items-table-wrap" style="margin-top:16px;">
    {% include "ledger/partials/items_table.html" with items=items %}
  </div>

  <!-- مودال ثبت کالا به partials/modals.html منتقل شد -->
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function(){
    const q = document.querySelector("input[name='q']");
    if(q) { setTimeout(() => q.focus(), 100); }
  });
</script>
{% endblock %}
