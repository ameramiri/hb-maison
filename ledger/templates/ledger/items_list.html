{% extends 'base.html' %}
{% load static %}
{% load format_filters %}

{% block title %}مدیریت کالاها{% endblock %}

{% block content %}
  <h2>مدیریت کالاها</h2>

<form method="get" class="filter-form"
      style="margin:1rem 0; display:flex; flex-wrap:wrap; gap:.75rem; align-items:center;">

  <input type="text" name="q" value="{{ q }}"
         placeholder="جستجو در نام کالاها…"
         style="padding:.4rem .6rem; width:200px;"
         onkeydown="if(event.key==='Enter'){ this.form.submit(); }">

  <button type="button" id="btn-add-item" class="submit-btn">➕ ایجاد کالا</button>

  <div style="display:flex; flex-direction:column; gap:.5rem; flex-basis:100%; margin-top:.25rem;">

    <!-- خط اول -->
    <div style="display:flex; align-items:center; gap:1rem;">
      <label style="display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; min-width:100px;">
        <input id="exclude_zero" type="checkbox" name="exclude_zero"
               {% if exclude_zero %}checked{% endif %}
               style="margin:0; width:16px; height:16px; cursor:pointer;">
        فقط موجودی دارها
      </label>
      <div class="totals-bar-single">
        <span class="label"><strong>ارزش فروش موجودی:</strong></span>
        <span class="value" dir="ltr">{{ totals.sum_sales|fa_thousand }}</span>
      </div>
    </div>

    <!-- خط دوم -->
    <div style="display:flex; align-items:center; gap:1rem;">
      <label style="display:inline-flex; align-items:center; gap:.35rem; cursor:pointer; min-width:100px;">
        <input id="only_consignment" type="checkbox" name="only_consignment"
               {% if only_consignment %}checked{% endif %}
               style="margin:0; width:16px; height:16px; cursor:pointer;">
        فقط کالاهای امانی
      </label>
      <div class="totals-bar-single">
        <span class="label"><strong>ارزش خرید موجودی:</strong></span>
        <span class="value" dir="ltr">{{ totals.sum_inventory|fa_thousand }}</span>
      </div>
    </div>

  </div>

</form>

  <!-- لیست کالاها -->
  <div id="items-table-wrap" style="margin-top:16px;">
    {% include "ledger/partials/items_table.html" with items=items %}
  </div>

  <!-- مودال ثبت کالا -->
  <div id="item-create-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h3 id="item-create-modal-title">کالای جدید</h3>
        <button type="button" id="item-create-modal-close">×</button>
      </div>
      <div class="modal-body" id="item-create-modal-body">
        <!-- فرم با Ajax لود می‌شود -->
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const btnAdd      = document.getElementById('btn-add-item');
  const modal       = document.getElementById('item-create-modal');
  const modalBody   = document.getElementById('item-create-modal-body');
  const modalClose  = document.getElementById('item-create-modal-close');
  const modalTitle  = document.getElementById('item-create-modal-title');
  const tableWrap   = document.getElementById('items-table-wrap');

  modalTitle.style.paddingRight = "12px";

  // باز کردن مودال
  btnAdd.addEventListener('click', ()=>{
    fetch("{% url 'item_create' %}")
      .then(r=>r.text())
      .then(html=>{
        modalBody.innerHTML = html;
        modal.style.display = 'block';

        const sellPrice   = setupNumericField('sell_price', 0);
        const commAmount  = setupNumericField('commission_amount', 0);
        const commPercent = setupNumericField('commission_percent', 2);
        const groupSelect = modalBody.querySelector('#group');
        if (groupSelect && window.jQuery) {
          $(groupSelect).select2({
            dir:'rtl',
            placeholder: 'انتخاب گروه کالا',
            sorter: function(data) {
              return data.sort((a, b) => a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' }));
            }
          });
        }
      });
  });

  window.addEventListener('load', function() {
    const qInput = document.querySelector('input[name="q"]');
    if (qInput) qInput.focus();
  });

  document.getElementById('exclude_zero').addEventListener('change', function() {
    document.querySelector('.filter-form').submit();
  });

  document.getElementById('only_consignment').addEventListener('change', function() {
    document.querySelector('.filter-form').submit();
  });

  // بستن مودال
  modalClose.addEventListener('click', ()=> modal.style.display='none');
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){ modal.style.display='none' }
  });

  // بستن با کلیک روی پس‌زمینه
  modal.addEventListener('click', (e)=>{
    if(e.target === modal){ modal.style.display='none' }
  });

  // هندل کردن submit فرم
  modalBody.addEventListener('submit', function(e){
    if(e.target.matches('#item-create-form')){
      e.preventDefault();
      const formData = new FormData(e.target);

      fetch(e.target.action, {
        method:'POST',
        body: formData,
        headers:{ 'X-Requested-With':'XMLHttpRequest' }
      })
      .then(r=>r.json())
      .then(data=>{
        if(data.success){
          modal.style.display = 'none';
          tableWrap.innerHTML = data.table_html;
        } else {
          modalBody.innerHTML = data.form_html;
        }
      });
    }
  });
});
</script>
{% endblock %}
