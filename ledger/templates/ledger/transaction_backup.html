{% extends 'base.html' %}
{% load static %}
{% load format_filters %}

{% block title %}Ø«Ø¨Øª {{ op_type }}{% endblock %}

{% block content %}
  <h2>Ø«Ø¨Øª {{ op_type }}</h2>

  {% if messages %}
    {% for message in messages %}
      <p class="success">{{ message }}</p>
    {% endfor %}
  {% endif %}

  <style>
    .party-inline{ display:flex; align-items:center; gap:8px; }
    .icon-btn{ border:1px solid #d0d5dd; background:#f9fafb; border-radius:8px; padding:6px 8px; cursor:pointer; }
    .icon-btn:hover{ background:#eef2f7; }

    .disabled-btn {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Ø¬Ø¯ÙˆÙ„ Â«Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§Â» Ù¾Ø§ÛŒÛŒÙ† ÙØ±Ù… */
    .table-pro.tx-last { table-layout: fixed; width: 100%; border-collapse: separate; }
    .table-pro.tx-last th, .table-pro.tx-last td { padding: 10px 12px; vertical-align: middle; }

    /* â€”â€”â€” Ù‡Ù…â€ŒØ±Ø§Ø³ØªØ§Ø³Ø§Ø²ÛŒ ØªØ§Ø±ÛŒØ®: Ù‡Ø¯Ø± Ø±Ø§Ø³Øªâ€ŒÚ†ÛŒÙ†ØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ³Ø· â€”â€”â€” */
    .table-pro.tx-last th.c-date { text-align: right; }   /* Ù„ÛŒØ¨Ù„ ØªØ§Ø±ÛŒØ® Ø±Ø§Ø³Øª */
    .table-pro.tx-last td.c-date { text-align: right; }  /* Ù…Ù‚Ø§Ø¯ÛŒØ± ØªØ§Ø±ÛŒØ® Ø±Ø§Ø³Øª */

    /* Ø§Ú¯Ø± padding Ù‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø¬Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯ØŒ Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù†Ø¯ */
    .table-pro.tx-last th.c-qty,  .table-pro.tx-last td.c-qty  { text-align: center; }

    /* Ø³ØªÙˆÙ† Ú©Ø§Ù„Ø§ */
    .table-pro.tx-last .c-item {
      min-width: 110px;   /* Ø§Ù„Ø§Ù† Ù…Ø«Ù„Ø§Ù‹ Ø±ÙˆÛŒ 140 ÛŒØ§ 160 Ø¨Ø°Ø§Ø±ÛŒÙ… */
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    /* ØªÛŒØªØ± Ø³ØªÙˆÙ† Ú©Ø§Ù„Ø§ */
    .table-pro.tx-last th.c-item {
      white-space: nowrap;
    }


    /* â€”â€”â€” Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÙˆÛŒâ€ŒÙ‡Ù…â€ŒØ§ÙØªØ§Ø¯Ù† Ù…ØªÙ†â€ŒÙ‡Ø§ â€”â€”â€” */
    .table-pro.tx-last th,
    .table-pro.tx-last td {
      line-height: 1.6;     /* Ø§Ø±ØªÙØ§Ø¹ Ø®Ø· Ú©Ø§ÙÛŒ */
    }

    /* Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ø·ÙˆÛŒÙ„ Ø¨Ø§ Ø³Ù‡â€ŒÙ†Ù‚Ø·Ù‡ */
    .table-pro.tx-last .text-clip {
      max-width: 100%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    /* â€”â€”â€” Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ â€”â€”â€” */
    @media (max-width: 640px) {
      /* Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø®ÙˆØ¯Ø´ Ø¹Ø±Ø¶ Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø¯Ù‡Ø¯ */
      .table-pro.tx-last { table-layout: auto; }

      /* Ú©Ù…ÛŒ padding Ú©Ù…ØªØ± ØªØ§ Ø¬Ø§ Ø¨Ø§Ø² Ø´ÙˆØ¯ */
      .table-pro.tx-last th,
      .table-pro.tx-last td { padding: 6px 8px; line-height: 1.6; }

      /* Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ ÙØ´Ø±Ø¯Ù‡â€ŒØªØ± */
      .table-pro.tx-last .c-date  { width: 86px; }
      .table-pro.tx-last .c-type  { width: 74px; text-align: center; }
      .table-pro.tx-last .c-qty   { width: 64px; text-align: center; }
      .table-pro.tx-last .c-unit  { width: 96px; text-align: center; }
      .table-pro.tx-last .c-total { width: 110px; text-align: center; }

      /* Ø³ØªÙˆÙ† Ú©Ø§Ù„Ø§ ÙØ¶Ø§ÛŒ Ø­Ø¯Ø§Ù‚Ù„ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ Ùˆ Ù…ØªÙ†Ø´ Ù…Ø±ØªØ¨ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯ */
      .table-pro.tx-last .c-item  { min-width: 150px; }

      /* Ú¯Ø²ÛŒÙ†Ù‡ Û±: Ø¨Ø±ÛŒØ¯Ù‡ Ø¨Ø§ Ø³Ù‡â€ŒÙ†Ù‚Ø·Ù‡ (Ø¸Ø§Ù‡Ø± Ù…Ø±ØªØ¨â€ŒØªØ±) */
      .table-pro.tx-last th.c-item,
      .table-pro.tx-last td.c-item {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ ØªÛŒØªØ±/Ù…Ù‚Ø¯Ø§Ø± Â«Ú©Ø§Ù„Ø§Â» Ø¯ÙˆØ®Ø·ÛŒ Ø¨Ø´ÙˆØ¯ (Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ø³Ù‡â€ŒÙ†Ù‚Ø·Ù‡)ØŒ
         Ø³Ù‡ Ø®Ø· Ø¨Ø§Ù„Ø§ Ø±Ø§ Ú©Ø§Ù…Ù†Øª Ú©Ù† Ùˆ Ø§ÛŒÙ† ÛŒÚ©ÛŒ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†: */
      /* .table-pro.tx-last th.c-item,
         .table-pro.tx-last td.c-item { white-space: normal; word-break: break-word; } */

      /* Ø¨Ø¬ Ø¨Ø±Ø§ÛŒ Â«Ø®Ø±ÛŒØ¯/ÙØ±ÙˆØ´Â» Ú©ÙˆÚ†Ú©â€ŒØªØ± Ú©Ù‡ Ø¬Ø§ Ù†Ú¯ÛŒØ±Ø¯ */
      .table-pro.tx-last .badge-op { padding: 2px 8px; font-size: 12px; }
    }
  </style>

  <form id="main-form" method="post" action="">
    {% csrf_token %}

    <div class="form-row">
      {{ form.date_shamsi.label_tag }}
      {{ form.date_shamsi }}
    </div>

    <div class="form-row">
      {{ form.party.label_tag }}
      <div class="party-inline">
        <select id="party" name="party" class="select2" required>
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
          {% for party in parties %}
            <option value="{{ party.id }}">{{ party.name }}</option>
          {% endfor %}
        </select>
        {% if page_source == 'sell' %}
          <button type="button" id="btn-party-modal" class="icon-btn" disabled title="ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ">ğŸ”</button>
        {% elif page_source == 'buy' %}
          <button type="button" id="btn-party-modal" class="icon-btn" disabled title="ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ø§ÛŒ Ø§ÛŒÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡">ğŸ”</button>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      {{ form.item.label_tag }}
      <div class="party-inline">
        <select id="item" name="item" class="select2" required>
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
          {% for item in items %}
            <option value="{{ item.id }}">{{ item.name }}</option>
          {% endfor %}
        </select>
        <button type="button" id="btn-item-modal" class="icon-btn" disabled title="ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ù„Ø§">ğŸ”</button>
      </div>
    </div>

    <div class="form-row">
      {{ form.qty.label_tag }}
      <input type="text" id="qty" name="qty" class="unit-price-short-field" placeholder="ØªØ¹Ø¯Ø§Ø¯"
        {% if op_type == 'ÙØ±ÙˆØ´' %}value="Û±"{% endif %}>
        <span style="margin-right: 5px;">Ù…ÙˆØ¬ÙˆØ¯ÛŒ:</span>
        <span id="stock-display" style="margin-right: 4px; color:#555;">â€”</span>
        <span id="stock-unit"    style="margin-right: 2px; color:#555;"></span>
    </div>

    <div class="form-row">
      {{ form.unit_price.label_tag }}
      <input type="text" id="unit_price" name="unit_price" class="unit-price-short-field"  placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯">

      <span style="margin-right: 10px; color: #007BFF;" id="sell-price-display">â€”</span>
      <span style="margin-right: 5px;">ØªÙˆÙ…Ø§Ù†</span>
    </div>

    <div class="form-row">
      {{ form.total_price.label_tag }}
      <input type="text" id="total_price" name="total_price" class="digit-input" placeholder="Ù‚ÛŒÙ…Øª Ú©Ù„"
           {% if readonly_total_price %}readonly{% endif %}>
    </div>

    <button type="submit" class="submit-btn">Ø«Ø¨Øª {{ op_type }}</button>

    <h3 style="margin-top: 24px; display:flex; align-items:center; gap:12px;">
      Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
      <span style="font-weight:normal; color:#6b7280;">(ØªØ¹Ø¯Ø§Ø¯)</span>
      <input type="number" id="recent-limit" min="1" max="200" value="20" style="width:90px; height:32px; padding:2px 8px;">
    </h3>

    <div class="table-wrap table-scroll">
      <table class="table-pro tx-last">
        <colgroup>
          <col class="c-date">
          <col class="c-type">
          <col class="c-party">
          <col class="c-item">
          <col class="c-qty">     <!-- ØªØ¹Ø¯Ø§Ø¯ -->
          <col class="c-unit">
          <col class="c-total">
        </colgroup>
        <thead>
          <tr>
            <th class="c-date">ØªØ§Ø±ÛŒØ®</th>
            <th class="c-type">Ø¹Ù…Ù„ÛŒØ§Øª</th>
            <th class="c-party">Ø·Ø±Ù Ù…Ø¹Ø§Ù…Ù„Ù‡</th>
            <th class="c-item">Ú©Ø§Ù„Ø§</th>
            <th class="c-qty">ØªØ¹Ø¯Ø§Ø¯</th>
            <th class="c-unit">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
            <th class="c-total">Ø¬Ù…Ø¹ Ú©Ù„</th>
          </tr>
        </thead>


        <tbody id="recent-tx-body">
          {% for tx in recent_transactions %}
          <tr>
            <td class="c-date text-clip">{{ tx.date_shamsi|to_persian_digits }}</td>
            <td class="c-type">
              <span class="badge-op {{ tx.op_badge_class }}">{{ tx.op_label }}</span>
            </td>
            <td class="c-party text-clip">{{ tx.party.name }}</td>
            <td class="c-item  text-clip">{{ tx.item.name }}</td>
            <td class="c-qty  ">{{ tx.qty|fa_thousand }}</td>
            <td class="c-unit num">{{ tx.unit_price|fa_thousand }}</td>
            <td class="c-total num">{{ tx.total_price|fa_thousand }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="7"><div class="empty-state">Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div></td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div id="party-modal"
       class="modal"
       style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;"
       tabindex="-1"
       onkeydown="
         if(event.key==='Enter'){ event.preventDefault(); event.stopPropagation(); }
         if(event.key==='Escape'){ this.style.display='none'; }
       ">

      {% if page_source == 'sell' %}
        {% with party_label="Ù…Ø´ØªØ±ÛŒ" %}
          {% include "ledger/partials/party_modal_table.html" %}
        {% endwith %}
      {% elif page_source == 'buy' %}
        {% with party_label="ÙØ±ÙˆØ´Ù†Ø¯Ù‡" %}
          {% include "ledger/partials/party_modal_table.html" %}
        {% endwith %}
      {% endif %}
    </div>

    <div id="item-modal"
         class="modal"
         style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;"
         tabindex="-1"
         onkeydown="
           if(event.key==='Enter'){ event.preventDefault(); event.stopPropagation(); }
           if(event.key==='Escape'){ this.style.display='none'; }
         ">

      {% include "ledger/partials/item_modal_table.html" %}
    </div>




    <!-- Modal -->
    <div id="tx-modal" class="modal" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="tx-modal-title">Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
          <button type="button" id="tx-modal-close">Ã—</button>
        </div>
        <div class="modal-body">
          <table class="table-pro tx-last">
            <thead>
              <tr>
                <th>ØªØ§Ø±ÛŒØ®</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                <th>Ú©Ø§Ù„Ø§</th>
                <th>ØªØ¹Ø¯Ø§Ø¯</th>
                <th>ÙÛŒ</th>
                <th>Ù…Ø¨Ù„Øº Ú©Ù„</th>
                <th>Ø·Ø±Ù Ø­Ø³Ø§Ø¨</th>
                <th>Ù…Ø§Ù†Ø¯Ù‡</th>
                <th>ØªÙˆØ¶ÛŒØ­</th>
              </tr>
            </thead>
            <tbody id="tx-modal-rows">
              <tr><td colspan="9" class="text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>






  </form>

{% endblock %}

{% block scripts %}
<script>



<script>
(function(){
  const modal = document.getElementById('tx-modal');
  const modalClose = document.getElementById('tx-modal-close');
  const modalRows = document.getElementById('tx-modal-rows');
  const modalTitle = document.getElementById('tx-modal-title');

  function openModal(){ modal.style.display = 'block'; }
  function closeModal(){ modal.style.display = 'none'; }
  modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function loadIntoModal(url, title){
    modalTitle.textContent = title || 'Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§';
    modalRows.innerHTML = `<tr><td colspan="9" class="text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>`;
    openModal();
    try{
      const res = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
      const text = await res.text();
      if(!res.ok){
        modalRows.innerHTML = `<tr><td colspan="9"><pre style="white-space:pre-wrap">${escapeHtml(text).slice(0,4000)}</pre></td></tr>`;
      }else{
        modalRows.innerHTML = text;
      }
    }catch(err){
      modalRows.innerHTML = `<tr><td colspan="9">Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡.</td></tr>`;
    }
  }

  // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ (ÙØ±Ø¶: Ø¢ÛŒØ¯ÛŒâ€ŒÙ‡Ø§ Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ù‡Ø³ØªÙ†Ø¯Ø› Ø§Ú¯Ø± Ù…ØªÙØ§ÙˆØªâ€ŒØ§Ù†Ø¯ØŒ Ø§ØµÙ„Ø§Ø­ Ú©Ù†)
  const btnParty = document.getElementById('btn-party-modal');
  const btnItem  = document.getElementById('btn-item-modal');
  const partySelect = document.getElementById('id_party');
  const itemSelect  = document.getElementById('id_item');

  if(btnParty){
    btnParty.addEventListener('click', ()=>{
      const pid = partySelect ? partySelect.value : '';
      if(!pid){ alert('Ù„Ø·ÙØ§Ù‹ Ø·Ø±Ù Ø­Ø³Ø§Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); return; }
      loadIntoModal(`/ajax/party-txs/?party_id=${encodeURIComponent(pid)}&limit=20`, 'ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø·Ø±Ù Ø­Ø³Ø§Ø¨');
    });
  }

  if(btnItem){
    btnItem.addEventListener('click', ()=>{
      const iid = itemSelect ? itemSelect.value : '';
      if(!iid){ alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ù„Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.'); return; }
      loadIntoModal(`/ajax/item-txs/?item_id=${encodeURIComponent(iid)}&limit=20`, 'ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ù„Ø§');
    });
  }
})();
</script>










window.PAGE_SOURCE = "{{ page_source }}";

document.addEventListener('DOMContentLoaded', function () {
  // Ø§Ú¯Ø± jQuery/Select2 Ø¯Ø± base.html Ù„ÙˆØ¯ Ø´Ø¯Ù‡ØŒ Ø§ÛŒÙ†Ø¬Ø§ ÙØ¹Ø§Ù„Ø´ Ú©Ù†
  if (window.jQuery) {
    $('#item').select2({  width:'215px', dir:'rtl', placeholder:'Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ù„Ø§' });
    $('#party').select2({ width:'215px', dir:'rtl', placeholder:'Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ù Ø­Ø³Ø§Ø¨' });
  }

  const partySelectEl = document.getElementById('party');
  const partyBtn      = document.getElementById('btn-party-modal');

  const itemSelectEl = document.getElementById('item');
  const itemBtn      = document.getElementById('btn-item-modal');

  // Ø³Øª Ú©Ø±Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± limit Ø¯Ø± ØµÙˆØ±Øª ØªØºÛŒÛŒØ± Ø·Ø±Ù Ø­Ø³Ø§Ø¨ ÛŒØ§ Ú©Ø§Ù„Ø§
  const DEFAULT_LIMIT = 50;

  function ensureLimit(el){
    if (el && (el.value === '' || isNaN(parseInt(el.value, 10)))) {
      el.value = DEFAULT_LIMIT;
    }
  }

  const resetPartyLimit = () => {
    const el = document.getElementById('party-modal-limit');
    if (el) el.value = DEFAULT_LIMIT;
  };
  if (partySelectEl) {
    partySelectEl.addEventListener('change', resetPartyLimit);
    if (window.jQuery) {
      $('#party').on('select2:select select2:clear', resetPartyLimit);
    }
  }

  const resetItemLimit = () => {
    const el = document.getElementById('item-modal-limit');
    if (el) el.value = DEFAULT_LIMIT;
  };
  if (itemSelectEl) {
    itemSelectEl.addEventListener('change', resetItemLimit);
    if (window.jQuery) {
      $('#item').on('select2:select select2:clear', resetItemLimit);
    }
  }

  // ÙØ¹Ø§Ù„ Ùˆ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† button Ø¬Ø³ØªØ¬ÙˆÛŒ Ø·Ø±Ù Ø­Ø³Ø§Ø¨
  function updatePartyBtn() {
    if (!partyBtn) return;
    const hasVal = !!(partySelectEl && partySelectEl.value);
    partyBtn.disabled = !hasVal;
    partyBtn.classList.toggle('disabled-btn', !hasVal);
  }

  if (partySelectEl) {
    // ØªØºÛŒÛŒØ±Ù Ù†ÙÛŒØªÛŒÙˆ
    partySelectEl.addEventListener('change', updatePartyBtn);
    // ØªØºÛŒÛŒØ±Ù Select2
    if (window.jQuery && $('#party').data('select2')) {
      $('#party').on('select2:select select2:clear', updatePartyBtn);
    }
  }
  // ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
  updatePartyBtn();

  // ÙØ¹Ø§Ù„ Ùˆ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† button Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ù„Ø§
  function updateItemBtn() {
    if (!itemBtn) return;
    const hasVal = !!(itemSelectEl && itemSelectEl.value);
    itemBtn.disabled = !hasVal;
    itemBtn.classList.toggle('disabled-btn', !hasVal);
  }

  if (itemSelectEl) {
    itemSelectEl.addEventListener('change', updateItemBtn);
    if (window.jQuery && $('#item').data('select2')) {
      $('#item').on('select2:select select2:clear', updateItemBtn);
    }
  }
  updateItemBtn();

  // --- Ù…ÙˆØ¯Ø§Ù„ Ú©Ø§Ù„Ø§
  const itemModal      = document.getElementById('item-modal');
  const itemModalClose = document.getElementById('item-modal-close');
  const itemModalBody  = document.getElementById('item-modal-body');
  const itemModalLimit = document.getElementById('item-modal-limit');

  function openItemModal(){
    if (!itemSelectEl || !itemSelectEl.value) {
      alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ù„Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
      return;
    }

    const itemNameEl = document.getElementById('item-modal-title-name');
    if (itemNameEl && itemSelectEl && itemSelectEl.selectedIndex >= 0) {
      itemNameEl.textContent = itemSelectEl.options[itemSelectEl.selectedIndex].text;
    }

    itemModal.style.display = 'block';
//    document.getElementById('item-modal-limit').focus();
    ensureLimit(itemModalLimit);
    loadItemTx();
  }
  function closeItemModal(){ itemModal.style.display = 'none'; }

  function loadItemTx(){
    const iid = itemSelectEl.value;
    const n = Math.max(1, Math.min(200, parseInt(itemModalLimit.value, 10)));

    const source = window.PAGE_SOURCE || "";
    itemModalBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</td></tr>';

    fetch("{% url 'get_item_transactions' %}?item="+encodeURIComponent(iid)+"&limit="+n+"&source="+encodeURIComponent(source), {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(async (r) => {
      const text = await r.text();
      itemModalBody.innerHTML = r.ok
        ? text
        : (/^\s*</.test(text) ? text
           : `<tr><td colspan="6" style="color:#b00020;white-space:pre-wrap;direction:ltr;text-align:left">Ø®Ø·Ø§: ${text}</td></tr>`);
    })
    .catch(err => {
      console.error(err);
      itemModalBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#b00020;">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯</td></tr>';
    });
  }

  if (itemBtn)         itemBtn.addEventListener('click', openItemModal);
  if (itemModalClose)  itemModalClose.addEventListener('click', closeItemModal);
  if (itemModal)       itemModal.addEventListener('click', (e)=>{ if(e.target === itemModal) closeItemModal(); });
  if (itemModalLimit)  itemModalLimit.addEventListener('input', ()=>{ clearTimeout(window.__it); window.__it = setTimeout(loadItemTx, 200); });

  // Ù…ÙˆØ¯Ø§Ù„ Ù…Ø´ØªØ±ÛŒ
  const partyModal      = document.getElementById('party-modal');
  const partyModalClose = document.getElementById('party-modal-close');
  const partyModalBody  = document.getElementById('party-modal-body');
  const partyModalLimit = document.getElementById('party-modal-limit');

  const openPartyModal = () => {
    if (!partySelectEl || !partySelectEl.value) {
      alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù…Ø´ØªØ±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
      return;
    }

    const partyNameEl = document.getElementById('party-modal-title-name');
    if (partyNameEl && partySelectEl && partySelectEl.selectedIndex >= 0) {
      partyNameEl.textContent = partySelectEl.options[partySelectEl.selectedIndex].text;
    }

    partyModal.style.display = 'block';
//    document.getElementById('party-modal-limit').focus();
    ensureLimit(partyModalLimit);
    loadPartyTx();
  };
  const closePartyModal = () => { partyModal.style.display = 'none'; };

  const loadPartyTx = () => {
    const pid = partySelectEl.value;
    const n = Math.max(1, Math.min(200, parseInt(itemModalLimit.value, 10)));
    const source = window.PAGE_SOURCE || "";

    partyModalBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</td></tr>';


    fetch("{% url 'get_party_transactions' %}?party="+encodeURIComponent(pid)+"&limit="+n+"&source="+encodeURIComponent(source), {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(async (r) => {
      const text = await r.text();   // Ù…ØªÙ† Ù¾Ø§Ø³Ø® Ø±Ø§ Ù‡Ù… Ø¨Ú¯ÛŒØ±
      // Ø§Ú¯Ø± OK Ù†Ø¨ÙˆØ¯ØŒ Ù‡Ù…Ø§Ù† Ù…ØªÙ† Ø±Ø§ Ø¯Ø§Ø®Ù„ tbody Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡ ØªØ§ Ø®Ø·Ø§ Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒ
      partyModalBody.innerHTML = r.ok
        ? text
        : (/^\s*</.test(text) ? text : `<tr><td colspan="7" style="color:#b00020;white-space:pre-wrap;direction:ltr;text-align:left">${text}</td></tr>`);
    })
    .catch(err => {
      partyModalBody.innerHTML = `<tr><td colspan="7" style="color:#b00020;">${err}</td></tr>`;
    });
  };


//    fetch("{% url 'get_party_transactions' %}?party="+encodeURIComponent(pid)+"&limit="+n+"&source="+encodeURIComponent(source), {
//      headers: { 'X-Requested-With': 'XMLHttpRequest' }
//    })
//    .then(r => r.text().then(t => ({ ok: r.ok, status: r.status, text: t })))
//    .then(({ok, status, text}) => {
//      if (!ok) {
//        console.error('AJAX error', status, text);
//        partyModalBody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#b00020;">Ø®Ø·Ø§ ${status}</td></tr>`;
//        return;
//      }
//      partyModalBody.innerHTML = text;   // ÙÙ‚Ø· TR Ù‡Ø§
//    })
//    .catch(err => {
//      console.error(err);
//      partyModalBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#b00020;">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯</td></tr>';
//    });
//  };

  if (partyBtn) partyBtn.addEventListener('click', openPartyModal);
  if (partyModalClose) partyModalClose.addEventListener('click', closePartyModal);
  if (partyModal) partyModal.addEventListener('click', (e)=>{ if(e.target === partyModal) closePartyModal(); });
  if (partyModalLimit) partyModalLimit.addEventListener('input', ()=>{ clearTimeout(window.__pt); window.__pt=setTimeout(loadPartyTx, 200); });

  document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
      partyModal.style.display = 'none';
      itemModal.style.display = 'none';
    }
  });

  const opType          = "{{ op_type|default:'' }}";

  const itemSelect      = document.getElementById('item');
  const unitPriceInput  = document.getElementById('unit_price');
  const sellPriceDisp   = document.getElementById('sell-price-display');
  const endpoint = "{% url 'get_sell_price' %}";
  const stockDisp       = document.getElementById('stock-display');
  const stockUnitDisp   = document.getElementById('stock-unit');

  const qtyInput        = document.getElementById('qty');
  const totalPriceInput = document.getElementById('total_price');

// --- Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ØŒ ÙˆÙ„ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ---

  const dateShamsiInput = document.getElementById('id_date_shamsi'); // Ø§Ú¯Ø± id ÙØ±Ù‚ Ø¯Ø§Ø±Ø¯ØŒ Ù…Ø·Ø§Ø¨Ù‚ Ø±Ù†Ø¯Ø± Ø®ÙˆØ¯Øª Ø¹ÙˆØ¶ Ú©Ù†

  function toFaDigits(s){
    return String(s||'').replace(/[0-9]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
  }
  function toEnDigits(s){
    return String(s||'').replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
  }

  // Ø­ÛŒÙ† ØªØ§ÛŒÙ¾/Ù¾ÛŒØ³Øª: Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ
  if (dateShamsiInput) {
    const formatDateFa = () => {
      // ÙÙ‚Ø· Ø±Ù‚Ù…â€ŒÙ‡Ø§ Ø±Ø§ ÙØ§Ø±Ø³ÛŒ Ú©Ù†Ø› Ù†Ø´Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ù…Ø«Ù„ "-" ÛŒØ§ "/" Ø¯Ø³Øª Ù†Ù…ÛŒâ€ŒØ®ÙˆØ±Ù†Ø¯
      const val = dateShamsiInput.value;
      dateShamsiInput.value = toFaDigits(val);
    };
    dateShamsiInput.addEventListener('input', formatDateFa);
    dateShamsiInput.addEventListener('change', formatDateFa);

    // Ø¯Ø± Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡ ØµÙØ­Ù‡ Ù‡Ù… Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø±ÛŒ Ù‡Ø³ØªØŒ ÙØ§Ø±Ø³ÛŒâ€ŒØ§Ø´ Ú©Ù†
    formatDateFa();

    // Ù„Ø­Ø¸Ù‡ Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù…: Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ† ØªØ§ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø¨ØªÙˆÙ†Ù‡ ØªØ¨Ø¯ÛŒÙ„ ØªÙ‚ÙˆÛŒÙ… Ø±Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
    const formEl = dateShamsiInput.closest('form');
    if (formEl) {
      formEl.addEventListener('submit', () => {
        dateShamsiInput.value = toEnDigits(dateShamsiInput.value);
      });
    }
  }

  function toEn(s){
    s = String(s||'')
      // Ø­Ø°Ù Ø¹Ù„Ø§Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ù‡Øª Ù…ØªÙ† Ú©Ù‡ Ø¨Ø¹Ø¶ÛŒ Ú©ÛŒØ¨ÙˆØ±Ø¯Ù‡Ø§ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù†Ø¯
      .replace(/[\u200e\u200f]/g,'')
      // Ø­Ø°Ù Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø²Ø§Ø±Ú¯Ø§Ù†ÛŒ: Ú©Ø§Ù…Ø§ØŒ Ø¹Ø±Ø¨ÛŒØŒ NBSP Ùˆ NNBSP
      .replace(/[,\u066C\u00A0\u202F]/g,'')
      // ØªØ¨Ø¯ÛŒÙ„ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø¹Ø´Ø§Ø± Ø¹Ø±Ø¨ÛŒ (Ù«) Ùˆ Ù†Ù‚Ø·Ù‡ Ø¨Ù‡ Ù†Ù‚Ø·Ù‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
      .replace(/[Ù«.]/g,'.')
      // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
      .replace(/[Û°-Û¹]/g, d=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
    return s;
  }

  function fa(n){
    try {
      var num = Number(n);
      if (window.Intl && Intl.NumberFormat) {
        return new Intl.NumberFormat('fa-IR').format(num);
      }
      // fallback Ø³Ø§Ø¯Ù‡: Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø§ Ø³Ù‡â€ŒØ±Ù‚Ù…ÛŒ Ùˆ ØªØ¨Ø¯ÛŒÙ„ Ø±Ù‚Ù…â€ŒÙ‡Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
      return String(Math.trunc(num)).replace(/\B(?=(\d{3})+(?!\d))/g, 'Ù¬').replace(/\d/g, d=>'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]);
    } catch(e){
      return n;
    }
  }

  function num(el){ const v=toEn(el?.value||''); const n=parseFloat(v); return isNaN(n)?NaN:n; }
  function recalc(){
    const q=num(qtyInput), u=num(unitPriceInput);
    totalPriceInput && (totalPriceInput.value = (!isNaN(q)&&!isNaN(u)) ? fa(q*u) : '');
  }

  // ÙØ±Ù…Øª Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­ÛŒÙ† ØªØ§ÛŒÙ¾
  function formatOnInput(el){
    if(!el) return;
    el.addEventListener('input', () => {
      const raw = toEn(el.value);
      if (raw==='' || isNaN(raw)) return;
      el.value = fa(raw);
      recalc();
    });
    el.addEventListener('change', recalc);
  }
  formatOnInput(qtyInput);
  formatOnInput(unitPriceInput);

  // Ø¯Ø± Ø­Ø§Ù„Øª "Ø®Ø±ÛŒØ¯": Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Â«Ù‚ÛŒÙ…Øª Ú©Ù„Â» Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯ØŒ Â«Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯Â» Ø±Ø§ Ø§Ø² Ø±ÙˆÛŒ Ø¢Ù† Ø­Ø³Ø§Ø¨ Ú©Ù†
  if (opType !== 'ÙØ±ÙˆØ´' && totalPriceInput) {
    const backcalcUnit = () => {
      const q = num(qtyInput);
      const t = num(totalPriceInput);
      if (isNaN(q) || q <= 0 || isNaN(t)) return;
      const u = t / q;
      if (unitPriceInput) unitPriceInput.value = fa(u);
    };

    totalPriceInput.addEventListener('input', () => {
      const raw = toEn(totalPriceInput.value);
      if (raw === '' || isNaN(raw)) return;
      totalPriceInput.value = fa(raw);
      backcalcUnit();
    });
    totalPriceInput.addEventListener('change', backcalcUnit);
  }

  // Ù‚ÛŒÙ…Øª/Ù…ÙˆØ¬ÙˆØ¯ÛŒ/ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢ÛŒØªÙ… Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¨Ú¯ÛŒØ± Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
  if (itemSelect && sellPriceDisp) {
    const handler = () => {
      const itemId = itemSelect.value;
      if (!itemId) {
        sellPriceDisp.textContent = 'â€”';
        if (stockDisp)     stockDisp.textContent     = 'â€”';
        if (stockUnitDisp) stockUnitDisp.textContent = '';
        return;
      }

      fetch(`${endpoint}?item_id=${encodeURIComponent(itemId)}`, { credentials: 'same-origin' })
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(data => {
          const sp = Number(data?.sell_price);                 // Ù…Ù…Ú©Ù† Ø§Ø³Øª 0 Ù‡Ù… Ø¨Ø§Ø´Ø¯
          const st = Number(data?.stock);
          const un = (typeof data?.unit === 'string') ? data.unit : '';

          if (stockDisp)     stockDisp.textContent     = isNaN(st) ? 'â€”' : fa(st);
          if (stockUnitDisp) stockUnitDisp.textContent = un || '';
          sellPriceDisp.textContent = isNaN(sp) ? 'â€”' : fa(sp);
        })
        .catch(err => {
          console.error('get_sell_price error:', err);
          sellPriceDisp.textContent = 'â€”';
          if (stockDisp)     stockDisp.textContent     = 'â€”';
          if (stockUnitDisp) stockUnitDisp.textContent = '';
        });
    };

    // Ø¨Ø§ÛŒÙ†Ø¯ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (Ù‡Ù… Ù†ÛŒØªÛŒÙˆØŒ Ù‡Ù… Select2)
    itemSelect.addEventListener('change', handler);
    if (window.jQuery && $('#item').data('select2')) {
      $('#item').on('select2:select', handler);
    }

    // Ø§Ú¯Ø± Ø§Ø² Ù‚Ø¨Ù„ Ø¢ÛŒØªÙ…ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŒ Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ Ø¨Ú¯ÛŒØ±
    handler();
  }

  // Ø¨Ø®Ø´ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ù…ÙˆØ¯Ø§Ù„
  const recentBody = document.getElementById('recent-tx-body');
  const recentLimit = document.getElementById('recent-limit');

  // ØªØºÛŒÛŒØ± ØªØ¹Ø¯Ø§Ø¯ Â«Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§Â» Ø²ÛŒØ± ÙØ±Ù…
  const refreshRecent = () => {
    const n = Math.max(1, Math.min(200, parseInt(recentLimit.value||'20',10)));
    fetch("{% url 'get_recent_transactions' %}?limit=" + n + (opType ? ("&op_type=" + encodeURIComponent(opType)) : ""))
      .then(r => r.text())
      .then(html => { if (recentBody) recentBody.innerHTML = html; })
      .catch(console.error);
  };
  if (recentLimit) {
    let t=null;
    recentLimit.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(refreshRecent, 200); });
    recentLimit.addEventListener('change', refreshRecent);
  }

  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù„ÛŒØ³Øª Ø²ÛŒØ± ÙØ±Ù…
  refreshRecent();
});
</script>
{% endblock %}
