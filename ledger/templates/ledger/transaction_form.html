{% extends 'base.html' %}
{% load format_filters %}

{% block title %}Ø«Ø¨Øª {{ OP_LABELS|get_item:op_type }}{% endblock %}

{% block content %}
  <h2>Ø«Ø¨Øª {{ OP_LABELS|get_item:op_type }}</h2>

  {% if messages %}
    {% for message in messages %}
      <p class="success">{{ message }}</p>
    {% endfor %}
  {% endif %}

  <style>
    .icon-btn{ border:1px solid #d0d5dd; background:#f9fafb; border-radius:8px; padding:6px 8px; cursor:pointer; }
    .icon-btn:hover{ background:#eef2f7; }
    .disabled-btn{ opacity:.5; cursor:not-allowed; }

    .info-label-blue{ color:#007BFF; }
    .blink-label{ font-weight:bold; animation: blink-red-white 1.2s infinite; }

    @keyframes blink-red-white {
      0%, 100% { color: red; }
      50%      { color: white; }
    }
  </style>

  <form id="main-form" method="post" action="">
    {% csrf_token %}

    <div class="form-row">
      {{ form.date_shamsi_display.label_tag }}
      {{ form.date_shamsi }}          <!-- ÙÛŒÙ„Ø¯ Ø§ØµÙ„ÛŒ ØªØ§Ø±ÛŒØ® (Ù…Ø®ÙÛŒ) -->
      {{ form.date_shamsi_display }}  <!-- ÙÛŒÙ„Ø¯ Ø¬Ø¯Ø§ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® (Ù†Ù…Ø§ÛŒØ´ÛŒ) -->

      {% if op_type == OP_SELL %}
        <label for="{{ form.giftuse.id_for_label }}" style="cursor:pointer;">
          {{ form.giftuse }} {{ form.giftuse.label }}
        </label>
      {% endif %}
    </div>

    <div class="form-row">
      {{ form.party.label_tag }}
      {{ form.party }}
      <button type="button" id="btn-party-modal" class="icon-btn disabled-btn" disabled title="ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø·Ø±Ù Ø­Ø³Ø§Ø¨">ğŸ”</button>
      <button type="button" class="btn-add-party icon-btn"
          data-url="/party/create/"
          data-select="party" 
          data-context="{% if op_type == OP_SELL or op_type == OP_RCV %}customer{% else %}supplier{% endif %}">
          â•
      </button>
    </div>

    {% if op_type == OP_SELL or op_type == OP_BUY %}
      <div class="form-row">
        {{ form.item.label_tag }}
        {{ form.item }}
        <button type="button" id="btn-item-modal" class="icon-btn disabled-btn" disabled title="ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ù„Ø§">ğŸ”</button>
        <button type="button" class="btn-add-item icon-btn"
            data-url="/item/create/"
            data-select="item">
            â•
        </button>
      </div>

      <div class="form-row">
        {{ form.qty.label_tag }} {{ form.qty }}
        <span style="color:#555;">Ù…ÙˆØ¬ÙˆØ¯ÛŒ:</span>
        <span id="stock-display" style="color:#555;">â€”</span>
        <span id="stock-unit" style="color:#555;"></span>
      </div>

      <div class="form-row">
        {{ form.unit_price.label_tag }} {{ form.unit_price }}
        <span class="info-label-blue" id="sell-price-display">â€”</span>
        <span class="info-label-blue">ØªÙˆÙ…Ø§Ù†</span>
        <span id="consignment-display" class="blink-label"></span>
      </div>

      <div class="form-row">
        {{ form.total_price.label_tag }} {{ form.total_price }}
      </div>
    {% endif %}

    <div class="form-row">
      {{ form.payment_amount.label_tag }} {{ form.payment_amount }}   {{ form.payment_method }}
    </div>

    <div class="form-row">
      {{ form.description.label_tag }} {{ form.description }}
    </div>

    {% if op_type == OP_RCV or op_type == OP_PAY %}
      <div class="form-row">
        <span class="form-label">Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨:</span>
        <span class="info-label-blue" id="acc-balance">â€”</span>
        <span class="info-label-blue">ØªÙˆÙ…Ø§Ù†</span>
      </div>
    {% endif %}

    <button type="submit" class="submit-btn btn-lg">Ø«Ø¨Øª {{ OP_LABELS|get_item:op_type }}</button>

    <!-- Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ù‡Ø§ -->
    <div id="scroll-box" class="table-wrap table-scroll" style="max-height:300px; overflow-y:auto;">
      <table class="table-pro tx-last" style="table-layout: fixed; width: 100%; border-collapse: collapse;">
        <colgroup>
          <col style="width: 90px;">   <!-- ØªØ§Ø±ÛŒØ® -->
          <col style="width: 60px;">   <!-- Ø¹Ù…Ù„ÛŒØ§Øª -->
          <col style="width: 150px;">  <!-- Ø·Ø±Ù Ù…Ø¹Ø§Ù…Ù„Ù‡ -->
          {% if op_type == OP_SELL or op_type == OP_BUY %}
            <col style="width: 150px;">  <!-- Ú©Ø§Ù„Ø§ -->
            <col style="width: 40px;">   <!-- ØªØ¹Ø¯Ø§Ø¯ -->
            <col style="width: 100px;">  <!-- Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ -->
            <col style="width: 120px;">  <!-- Ø¬Ù…Ø¹ Ú©Ù„ / Ù…Ø¨Ù„Øº -->
            <col style="width: 120px;">  <!-- Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ -->
          {% else %}
            <col style="width: 120px;">  <!-- Ù…Ø¨Ù„Øº -->
          {% endif %}
          <col style="width: 350px;">  <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª -->
        </colgroup>
        <thead>
          <tr>
            <th>ØªØ§Ø±ÛŒØ®</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            <th style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">Ø·Ø±Ù Ù…Ø¹Ø§Ù…Ù„Ù‡</th>
            {% if op_type == OP_SELL or op_type == OP_BUY %}
              <th style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">Ú©Ø§Ù„Ø§</th>
              <th>ØªØ¹Ø¯Ø§Ø¯</th>
              <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
              <th>Ø¬Ù…Ø¹ Ú©Ù„</th>
              <th>Ù‚ÛŒÙ…Øª ØªÙ…Ø§Ù… Ø´Ø¯Ù‡</th>
            {% else %}
              <th>Ù…Ø¨Ù„Øº</th>
            {% endif %}
            <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="recent-tx-body" data-last-id="{{ recent_transactions.0.id }}">
          <tr><td style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis;" colspan="8" class="text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>
        </tbody>
      </table>
    </div>
  </form>
{% endblock %}

{% block scripts %}

<script>
  const OP_TYPE = "{{ op_type }}";
  const OP_SELL = "{{ OP_SELL }}";
  const OP_BUY  = "{{ OP_BUY }}";
  const OP_RCV  = "{{ OP_RCV }}";
  const OP_PAY  = "{{ OP_PAY }}";
  const OP_USE  = "{{ OP_USE }}";

  window.PAGE_SOURCE = "{{ page_source|default:'' }}";

  // Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
  function refreshRecent(){
    const recentBody  = document.getElementById('recent-tx-body');
     if (!recentBody) return;
    let url = "{% url 'get_recent_transactions' %}";
    if (typeof OP_TYPE !== 'undefined' && OP_TYPE) 
      url += "?op_type=" + encodeURIComponent(OP_TYPE);
    fetch(url)
      .then(r=>r.text())
      .then(html=>{ recentBody.innerHTML = html; })
      .catch(err=>console.error("âŒ refreshRecent error:", err));
  }

  document.addEventListener('DOMContentLoaded', function(){
  const fieldsToToggle = [
    document.getElementById('unit_price'),
    document.getElementById('total_price'),
    document.getElementById('payment_amount'),
    document.getElementById('payment_method')
  ];

  const integerFields = [
    document.getElementById('qty'),
    document.getElementById('unit_price'),
    document.getElementById('total_price'),
    document.getElementById('payment_amount')
  ];

  const qty        = setupNumericField('qty', 0, recalcTotal);
  const unitPrice  = setupNumericField('unit_price', 0, recalcTotal);
  const totalPrice = setupNumericField('total_price', 0);
  const payment    = setupNumericField('payment_amount', 0);

  // Select2 â€” Ù‚Ø¨Ù„ Ø§Ø² Ù†Ù…Ø§ÛŒØ´
  if (window.jQuery) {
    $('#party').select2({
        dir:'rtl', placeholder:'Ø§Ù†ØªØ®Ø§Ø¨ Ø·Ø±Ù Ø­Ø³Ø§Ø¨',
        sorter: function(data) {
          return data.sort(function(a, b) {
            return a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' });
          });
        }
    });
    $('#item').select2({
        dir:'rtl', placeholder:'Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ù„Ø§',
        sorter: function(data) {
          return data.sort(function(a, b) {
            return a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' });
          });
        }
    });
    $('#payment_method').select2({
        dir:'rtl',
        minimumResultsForSearch: Infinity,
        sorter: function(data) {
          return data.sort(function(a, b) {
            return a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' });
          });
        }
    });

    // ÙˆÙ‚ØªÛŒ Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ† Ø¨Ø§Ø² Ø´Ø¯ â†’ ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ Ø³Ø±Ú†
    $(document).on('select2:open', () => {
      document.querySelector('.select2-container--open .select2-search__field')?.focus();
    });
  }

  // ØªØ§Ø±ÛŒØ®
  const dateShamsiDisplay = document.getElementById('id_date_shamsi_display');
  const dateShamsiHidden  = document.getElementById('id_date_shamsi');

  if (dateShamsiDisplay && dateShamsiHidden){
    // Ù‡Ù…ÛŒØ´Ù‡ ÙˆØ±ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ùˆ ÙØ§Ø±Ø³ÛŒ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±
    const formatDateFa = ()=>{ dateShamsiDisplay.value = toFaDigits(dateShamsiDisplay.value); };
    formatDateFa();
    dateShamsiDisplay.addEventListener('input', formatDateFa);
    dateShamsiDisplay.addEventListener('change', formatDateFa);
  }

  // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§
  const itemSelect      = document.getElementById('item');
  const partySelect     = document.getElementById('party');
  const btnItemModal    = document.getElementById('btn-item-modal');
  const btnPartyModal   = document.getElementById('btn-party-modal');

  const qtyInput        = document.getElementById('qty');
  const unitPriceInput  = document.getElementById('unit_price');
  const totalPriceInput = document.getElementById('total_price');

  const sellPriceDisp   = document.getElementById('sell-price-display');
  const stockDisp       = document.getElementById('stock-display');
  const stockUnitDisp   = document.getElementById('stock-unit');
  const consignmentDisp = document.getElementById('consignment-display');

  // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
  function toggleBtn(selectEl, btn){
    if (!btn) return;
    const hasVal = !!(selectEl && selectEl.value);
    btn.disabled = !hasVal;
    btn.classList.toggle('disabled-btn', !hasVal);
  }
  partySelect?.addEventListener('change', ()=>toggleBtn(partySelect, btnPartyModal));
  itemSelect?.addEventListener('change',  ()=>toggleBtn(itemSelect,  btnItemModal));

  if (window.jQuery && $('#party').data('select2')) {
    $('#party').on('select2:select select2:clear', ()=>toggleBtn(partySelect, btnPartyModal));
  }
  if (window.jQuery && $('#item').data('select2')) {
    $('#item').on('select2:select select2:clear', ()=>toggleBtn(itemSelect, btnItemModal));
  }

  // ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
  toggleBtn(partySelect, btnPartyModal);
  toggleBtn(itemSelect,  btnItemModal);

  // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª Ú©Ù„ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ùˆ Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯
  function recalcTotal(){
    const q = num(qtyInput), u = num(unitPriceInput);
    if (!isNaN(q) && !isNaN(u)) {
      totalPriceInput.value = fa(q * u, 0);
    } else {
      totalPriceInput.value = '';
    }
  }

  setupNumericField('qty', 0, recalcTotal);
  setupNumericField('unit_price', 0, recalcTotal);

  const paymentAmountInput = document.getElementById('payment_amount');
  setupNumericField('payment_amount', 0);

  // Ø¯Ø± Ø®Ø±ÛŒØ¯: Ø¹Ù„Ø§ÙˆÙ‡ Ø¨Ø± Ø¨Ø§Ù„Ø§ØŒ ØªØºÛŒÛŒØ± Ù‚ÛŒÙ…Øª Ú©Ù„ Ø¨Ø§Ø¹Ø« Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ Ù…ÛŒØ´Ù‡
  if (OP_TYPE === OP_BUY) {
    function recalcUnit(){
      const q = num(qtyInput), t = num(totalPriceInput);
      if (isNaN(q) || q <= 0 || isNaN(t)) return;
      unitPriceInput.value = fa(Math.round(t / q), 0); // Ø±Ù†Ø¯ Ø¨Ø¯ÙˆÙ† Ø§Ø¹Ø´Ø§Ø±
    }

    setupNumericField('total_price', 0, recalcUnit);
  }

  // Ù‚ÛŒÙ…Øª Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ù„Ø§
  const endpoint = "{% url 'get_sell_price' %}";
  function updateItemInfo(){
    if (!itemSelect || !sellPriceDisp || !stockDisp || !stockUnitDisp) {
      return; // Ø§Ú¯Ø± Ø§ÛŒÙ† ØµÙØ­Ù‡ receipt/pay Ù‡Ø³ØªØŒ Ø§ÛŒÙ†Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù† â†’ Ù¾Ø³ Ù‡ÛŒÚ†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ù‡
    }

    const itemId = itemSelect?.value || '';
    if (!itemId){
      sellPriceDisp.textContent = 'â€”';
      stockDisp.textContent     = 'â€”';
      stockUnitDisp.textContent = '';
      consignmentDisp.textContent = '';
      return;
    }

    fetch(`${endpoint}?item_id=${encodeURIComponent(itemId)}`, { credentials:'same-origin' })
      .then(r=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
      .then(data=>{
        const sp = Number(data?.sell_price);
        const st = Number(data?.stock);
        const un = (typeof data?.unit === 'string') ? data.unit : '';
        const is_consignment = (data?.is_consignment);
        stockDisp.textContent     = isNaN(st) ? 'â€”' : fa(st, 0);
        stockUnitDisp.textContent = un || '';
        sellPriceDisp.textContent = isNaN(sp) ? 'â€”' : fa(sp, 0);
        consignmentDisp.textContent = is_consignment? 'Ø§Ù…Ø§Ù†ÛŒ' : '';
      })
      .catch(()=>{
        sellPriceDisp.textContent='â€”';
        stockDisp.textContent='â€”';
        stockUnitDisp.textContent='';
        consignmentDisp.textContent='';
      });
  }
  itemSelect?.addEventListener('change', updateItemInfo);
  if (window.jQuery && $('#item').data('select2')){
    $('#item').on('select2:select', updateItemInfo);
  }
  updateItemInfo();

  refreshRecent();

  // Ø¯Ú©Ù…Ù‡ Ú©Ù†Ø§Ø± Ø·Ø±Ù Ø­Ø³Ø§Ø¨
  btnPartyModal?.addEventListener('click', ()=>{
    const pid   = partySelect.value;
    const pname = partySelect.options[partySelect.selectedIndex]?.text || '';
    if (pid) {
      window.openPartyModalById?.(pid, pname);
    }
  });

  // Ø¯Ú©Ù…Ù‡ Ú©Ù†Ø§Ø± Ú©Ø§Ù„Ø§
  btnItemModal?.addEventListener('click', ()=>{
    const iid   = itemSelect.value;
    const iname = itemSelect.options[itemSelect.selectedIndex]?.text || '';
    if (iid) {
      window.openItemModalById?.(iid, iname);
    }
  });

  if (OP_TYPE === OP_SELL) {
    const giftuseCheckbox = document.getElementById('giftuse');

    // ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ø§ Ø²Ø¯Ù† Ø±ÙˆÛŒ Ú†Ú© Ø¨Ø§Ú©Ø³
    function toggleFields(){
      if (!giftuseCheckbox) return;

      const disable = giftuseCheckbox.checked;
      fieldsToToggle.forEach(f => {
        if (!f) return;

        if (disable) {
          // Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ Ø±Ùˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒÙ…
          f.dataset.savedValue = f.value;  // ÛŒÚ© Ø¨Ø§Ø± Ø°Ø®ÛŒØ±Ù‡

          f.value = '';        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø§Ù„ÛŒ
          f.disabled = true;   // ØºÛŒØ± ÙØ¹Ø§Ù„
        } else {
          // Ø¨Ø§Ø²Ú¯Ø±Ø¯ÙˆÙ†Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ
          if (f.dataset.savedValue !== undefined) {
            f.value = f.dataset.savedValue;
          }
          f.disabled = false;  // ÙØ¹Ø§Ù„
        }
      });
    }
    giftuseCheckbox.addEventListener('change', toggleFields);
    toggleFields();
  }

  // Ø¯Ø± Ø§Ù†ØªÙ‡Ø§: Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø¨Ø¯ÙˆÙ† Ú†Ø´Ù…Ú©
  document.getElementById('page-root')?.classList.remove('hide-until-ready');
});


function handleTransactionResponse(data) {
  if (data.success && data.operations && Array.isArray(data.operations)) {
    for (const op of data.operations) {
      const opType = (typeof op === "string") ? op : op.type;
      let msg = "";
      switch (opType) {
        case OP_SELL: msg = "ÙØ±ÙˆØ´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯"; break;
        case OP_BUY:  msg = "Ø®Ø±ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯"; break;
        case OP_RCV:  msg = "Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¬Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯"; break;
        case OP_PAY:  msg = "Ù¾Ø±Ø¯Ø§Ø®Øª ÙˆØ¬Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯"; break;
        case OP_USE:  msg = "Ù…ØµØ±Ù Ø´Ø®ØµÛŒ/Ù‡Ø¯ÛŒÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯"; break;
        default: msg = "Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯";
      }
      notify('success', msg);
    }
    const form = document.getElementById('main-form');
    if (form) form.reset();
    // Ø¨Ø¹Ø¯ Ø§Ø² reset ÙØ±Ù…ØŒ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙØ§Ø±Ø³ÛŒ Ú©Ù†
    const dateDisplay = document.getElementById('id_date_shamsi_display');
    if (dateDisplay && typeof toFaDigits === 'function') {
      dateDisplay.value = toFaDigits(dateDisplay.value);
    }

    form.querySelectorAll('select').forEach(sel => {
      sel.selectedIndex = -1;  // Ù‡ÛŒÚ† Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´ÙˆØ¯
      sel.dispatchEvent(new Event('change'));
    
    // ØªÙ†Ø¸ÛŒÙ… Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø­ÙˆÙ‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±ÙˆÛŒ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    const paymentMethodSelect = document.getElementById('payment_method');
    paymentMethodSelect.value = paymentMethodSelect.options[0].value;
    paymentMethodSelect.dispatchEvent(new Event('change'));

  });
    if (typeof refreshRecent === 'function') { refreshRecent(); }
  }
  else {
    if (data.errors) {
      const errs = Object.entries(data.errors).map(([k,v])=>`${k}: ${v}`).join(' | ');
      notify('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´: ' + errs);
    } else {
      notify('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´');
    }
  }
}

document.getElementById('main-form').addEventListener('submit', function(e){
  e.preventDefault();
  const form = e.target;

  const dateShamsiDisplay = document.getElementById('id_date_shamsi_display');
  const dateShamsiHidden  = document.getElementById('id_date_shamsi');
  if (dateShamsiDisplay && dateShamsiHidden) {
      dateShamsiHidden.value = toEnDigits(dateShamsiDisplay.value);
  }

  const formData = new FormData(form);
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {'X-Requested-With': 'XMLHttpRequest'}
  })
  .then(r => r.json())
  .then(data => {
    if (data._debug) {
      for (const log of data._debug) console.log(log);
    }
    handleTransactionResponse(data);
  })
  .catch(err => console.error("âŒ Fetch error:", err));
});
</script>
{% endblock %}
