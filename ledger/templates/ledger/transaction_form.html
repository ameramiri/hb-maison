{% extends 'base.html' %}
{% load format_filters %}

{% block title %}ثبت {{ OP_LABELS|get_item:op_type }}{% endblock %}

{% block content %}
  <h2>ثبت {{ OP_LABELS|get_item:op_type }}</h2>

  {% if messages %}
    {% for message in messages %}
      <p class="success">{{ message }}</p>
    {% endfor %}
  {% endif %}

  <style>
    .icon-btn{ border:1px solid #d0d5dd; background:#f9fafb; border-radius:8px; padding:6px 8px; cursor:pointer; }
    .icon-btn:hover{ background:#eef2f7; }
    .disabled-btn{ opacity:.5; cursor:not-allowed; }

    .info-label-blue{ color:#007BFF; }
    .blink-label{ font-weight:bold; animation: blink-red-white 1.2s infinite; }

    @keyframes blink-red-white {
      0%, 100% { color: red; }
      50%      { color: white; }
    }
  </style>

  <form id="main-form" method="post" action="">
    {% csrf_token %}

    <div class="form-row">
      {{ form.date_shamsi_display.label_tag }}
      {{ form.date_shamsi }}          <!-- فیلد اصلی تاریخ (مخفی) -->
      {{ form.date_shamsi_display }}  <!-- فیلد جدا برای تاریخ (نمایشی) -->

      {% if op_type == OP_SELL %}
        <label for="{{ form.giftuse.id_for_label }}" style="cursor:pointer;">
          {{ form.giftuse }} {{ form.giftuse.label }}
        </label>
      {% endif %}
    </div>

    <div class="form-row">
      {{ form.party.label_tag }}
      {{ form.party }}
      <button type="button" id="btn-party-modal" class="icon-btn disabled-btn" disabled title="تراکنش‌های این طرف حساب">🔎</button>
      <button type="button" class="btn-add-party icon-btn"
          data-url="/party/create/"
          data-select="party" 
          data-context="{% if op_type == OP_SELL or op_type == OP_RCV %}customer{% else %}supplier{% endif %}">
          ➕
      </button>
    </div>

    {% if op_type == OP_SELL or op_type == OP_BUY %}
      <div class="form-row">
        {{ form.item.label_tag }}
        {{ form.item }}
        <button type="button" id="btn-item-modal" class="icon-btn disabled-btn" disabled title="تراکنش‌های این کالا">🔎</button>
        <button type="button" class="btn-add-item icon-btn"
            data-url="/item/create/"
            data-select="item">
            ➕
        </button>
      </div>

      <div class="form-row">
        {{ form.qty.label_tag }} {{ form.qty }}
        <span style="color:#555;">موجودی:</span>
        <span id="stock-display" style="color:#555;">—</span>
        <span id="stock-unit" style="color:#555;"></span>
      </div>

      <div class="form-row">
        {{ form.unit_price.label_tag }} {{ form.unit_price }}
        <span class="info-label-blue" id="sell-price-display">—</span>
        <span class="info-label-blue">تومان</span>
        <span id="consignment-display" class="blink-label"></span>
      </div>

      <div class="form-row">
        {{ form.total_price.label_tag }} {{ form.total_price }}
      </div>
    {% endif %}

    <div class="form-row">
      {{ form.payment_amount.label_tag }} {{ form.payment_amount }}   {{ form.payment_method }}
    </div>

    <div class="form-row">
      {{ form.description.label_tag }} {{ form.description }}
    </div>

    {% if op_type == OP_RCV or op_type == OP_PAY %}
      <div class="form-row">
        <span class="form-label">مانده حساب:</span>
        <span class="info-label-blue" id="acc-balance">—</span>
        <span class="info-label-blue">تومان</span>
      </div>
    {% endif %}

    <button type="submit" class="submit-btn btn-lg">ثبت {{ OP_LABELS|get_item:op_type }}</button>

    <!-- آخرین تراکنش ها -->
    <div id="scroll-box" class="table-wrap table-scroll" style="max-height:300px; overflow-y:auto;">
      <table class="table-pro tx-last" style="table-layout: fixed; width: 100%; border-collapse: collapse;">
        <colgroup>
          <col style="width: 90px;">   <!-- تاریخ -->
          <col style="width: 60px;">   <!-- عملیات -->
          <col style="width: 150px;">  <!-- طرف معامله -->
          {% if op_type == OP_SELL or op_type == OP_BUY %}
            <col style="width: 150px;">  <!-- کالا -->
            <col style="width: 40px;">   <!-- تعداد -->
            <col style="width: 100px;">  <!-- قیمت واحد -->
            <col style="width: 120px;">  <!-- جمع کل / مبلغ -->
            <col style="width: 120px;">  <!-- قیمت تمام شده -->
          {% else %}
            <col style="width: 120px;">  <!-- مبلغ -->
          {% endif %}
          <col style="width: 350px;">  <!-- توضیحات -->
        </colgroup>
        <thead>
          <tr>
            <th>تاریخ</th>
            <th>عملیات</th>
            <th style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">طرف معامله</th>
            {% if op_type == OP_SELL or op_type == OP_BUY %}
              <th style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">کالا</th>
              <th>تعداد</th>
              <th>قیمت واحد</th>
              <th>جمع کل</th>
              <th>قیمت تمام شده</th>
            {% else %}
              <th>مبلغ</th>
            {% endif %}
            <th>توضیحات</th>
          </tr>
        </thead>
        <tbody id="recent-tx-body" data-last-id="{{ recent_transactions.0.id }}">
          <tr><td style="overflow:hidden; white-space:nowrap; text-overflow:ellipsis;" colspan="8" class="text-center">در حال بارگذاری...</td></tr>
        </tbody>
      </table>
    </div>
  </form>
{% endblock %}

{% block scripts %}

<script>
  const OP_TYPE = "{{ op_type }}";
  const OP_SELL = "{{ OP_SELL }}";
  const OP_BUY  = "{{ OP_BUY }}";
  const OP_RCV  = "{{ OP_RCV }}";
  const OP_PAY  = "{{ OP_PAY }}";
  const OP_USE  = "{{ OP_USE }}";

  window.PAGE_SOURCE = "{{ page_source|default:'' }}";

  // آخرین تراکنش‌ها
  function refreshRecent(){
    const recentBody  = document.getElementById('recent-tx-body');
     if (!recentBody) return;
    let url = "{% url 'get_recent_transactions' %}";
    if (typeof OP_TYPE !== 'undefined' && OP_TYPE) 
      url += "?op_type=" + encodeURIComponent(OP_TYPE);
    fetch(url)
      .then(r=>r.text())
      .then(html=>{ recentBody.innerHTML = html; })
      .catch(err=>console.error("❌ refreshRecent error:", err));
  }

  document.addEventListener('DOMContentLoaded', function(){
  const fieldsToToggle = [
    document.getElementById('unit_price'),
    document.getElementById('total_price'),
    document.getElementById('payment_amount'),
    document.getElementById('payment_method')
  ];

  const integerFields = [
    document.getElementById('qty'),
    document.getElementById('unit_price'),
    document.getElementById('total_price'),
    document.getElementById('payment_amount')
  ];

  const qty        = setupNumericField('qty', 0, recalcTotal);
  const unitPrice  = setupNumericField('unit_price', 0, recalcTotal);
  const totalPrice = setupNumericField('total_price', 0);
  const payment    = setupNumericField('payment_amount', 0);

  // Select2 — قبل از نمایش
  if (window.jQuery) {
    $('#party').select2({
        dir:'rtl', placeholder:'انتخاب طرف حساب',
        sorter: function(data) {
          return data.sort(function(a, b) {
            return a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' });
          });
        }
    });
    $('#item').select2({
        dir:'rtl', placeholder:'انتخاب کالا',
        sorter: function(data) {
          return data.sort(function(a, b) {
            return a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' });
          });
        }
    });
    $('#payment_method').select2({
        dir:'rtl',
        minimumResultsForSearch: Infinity,
        sorter: function(data) {
          return data.sort(function(a, b) {
            return a.text.localeCompare(b.text, 'fa', { sensitivity: 'base' });
          });
        }
    });

    // وقتی دراپ‌داون باز شد → فوکوس روی سرچ
    $(document).on('select2:open', () => {
      document.querySelector('.select2-container--open .select2-search__field')?.focus();
    });
  }

  // تاریخ
  const dateShamsiDisplay = document.getElementById('id_date_shamsi_display');
  const dateShamsiHidden  = document.getElementById('id_date_shamsi');

  if (dateShamsiDisplay && dateShamsiHidden){
    // همیشه ورودی کاربر رو فارسی نگه‌دار
    const formatDateFa = ()=>{ dateShamsiDisplay.value = toFaDigits(dateShamsiDisplay.value); };
    formatDateFa();
    dateShamsiDisplay.addEventListener('input', formatDateFa);
    dateShamsiDisplay.addEventListener('change', formatDateFa);
  }

  // المان‌ها
  const itemSelect      = document.getElementById('item');
  const partySelect     = document.getElementById('party');
  const btnItemModal    = document.getElementById('btn-item-modal');
  const btnPartyModal   = document.getElementById('btn-party-modal');

  const qtyInput        = document.getElementById('qty');
  const unitPriceInput  = document.getElementById('unit_price');
  const totalPriceInput = document.getElementById('total_price');

  const sellPriceDisp   = document.getElementById('sell-price-display');
  const stockDisp       = document.getElementById('stock-display');
  const stockUnitDisp   = document.getElementById('stock-unit');
  const consignmentDisp = document.getElementById('consignment-display');

  // فعال/غیرفعال کردن دکمه‌ها
  function toggleBtn(selectEl, btn){
    if (!btn) return;
    const hasVal = !!(selectEl && selectEl.value);
    btn.disabled = !hasVal;
    btn.classList.toggle('disabled-btn', !hasVal);
  }
  partySelect?.addEventListener('change', ()=>toggleBtn(partySelect, btnPartyModal));
  itemSelect?.addEventListener('change',  ()=>toggleBtn(itemSelect,  btnItemModal));

  if (window.jQuery && $('#party').data('select2')) {
    $('#party').on('select2:select select2:clear', ()=>toggleBtn(partySelect, btnPartyModal));
  }
  if (window.jQuery && $('#item').data('select2')) {
    $('#item').on('select2:select select2:clear', ()=>toggleBtn(itemSelect, btnItemModal));
  }

  // وضعیت اولیه
  toggleBtn(partySelect, btnPartyModal);
  toggleBtn(itemSelect,  btnItemModal);

  // محاسبه قیمت کل بر اساس تعداد و قیمت واحد
  function recalcTotal(){
    const q = num(qtyInput), u = num(unitPriceInput);
    if (!isNaN(q) && !isNaN(u)) {
      totalPriceInput.value = fa(q * u, 0);
    } else {
      totalPriceInput.value = '';
    }
  }

  setupNumericField('qty', 0, recalcTotal);
  setupNumericField('unit_price', 0, recalcTotal);

  const paymentAmountInput = document.getElementById('payment_amount');
  setupNumericField('payment_amount', 0);

  // در خرید: علاوه بر بالا، تغییر قیمت کل باعث محاسبه قیمت واحد میشه
  if (OP_TYPE === OP_BUY) {
    function recalcUnit(){
      const q = num(qtyInput), t = num(totalPriceInput);
      if (isNaN(q) || q <= 0 || isNaN(t)) return;
      unitPriceInput.value = fa(Math.round(t / q), 0); // رند بدون اعشار
    }

    setupNumericField('total_price', 0, recalcUnit);
  }

  // قیمت و موجودی کالا
  const endpoint = "{% url 'get_sell_price' %}";
  function updateItemInfo(){
    if (!itemSelect || !sellPriceDisp || !stockDisp || !stockUnitDisp) {
      return; // اگر این صفحه receipt/pay هست، اینا وجود ندارن → پس هیچی انجام نده
    }

    const itemId = itemSelect?.value || '';
    if (!itemId){
      sellPriceDisp.textContent = '—';
      stockDisp.textContent     = '—';
      stockUnitDisp.textContent = '';
      consignmentDisp.textContent = '';
      return;
    }

    fetch(`${endpoint}?item_id=${encodeURIComponent(itemId)}`, { credentials:'same-origin' })
      .then(r=>{ if(!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
      .then(data=>{
        const sp = Number(data?.sell_price);
        const st = Number(data?.stock);
        const un = (typeof data?.unit === 'string') ? data.unit : '';
        const is_consignment = (data?.is_consignment);
        stockDisp.textContent     = isNaN(st) ? '—' : fa(st, 0);
        stockUnitDisp.textContent = un || '';
        sellPriceDisp.textContent = isNaN(sp) ? '—' : fa(sp, 0);
        consignmentDisp.textContent = is_consignment? 'امانی' : '';
      })
      .catch(()=>{
        sellPriceDisp.textContent='—';
        stockDisp.textContent='—';
        stockUnitDisp.textContent='';
        consignmentDisp.textContent='';
      });
  }
  itemSelect?.addEventListener('change', updateItemInfo);
  if (window.jQuery && $('#item').data('select2')){
    $('#item').on('select2:select', updateItemInfo);
  }
  updateItemInfo();

  refreshRecent();

  // دکمه کنار طرف حساب
  btnPartyModal?.addEventListener('click', ()=>{
    const pid   = partySelect.value;
    const pname = partySelect.options[partySelect.selectedIndex]?.text || '';
    if (pid) {
      window.openPartyModalById?.(pid, pname);
    }
  });

  // دکمه کنار کالا
  btnItemModal?.addEventListener('click', ()=>{
    const iid   = itemSelect.value;
    const iname = itemSelect.options[itemSelect.selectedIndex]?.text || '';
    if (iid) {
      window.openItemModalById?.(iid, iname);
    }
  });

  if (OP_TYPE === OP_SELL) {
    const giftuseCheckbox = document.getElementById('giftuse');

    // فعال/غیرفعال کردن فیلدها با زدن روی چک باکس
    function toggleFields(){
      if (!giftuseCheckbox) return;

      const disable = giftuseCheckbox.checked;
      fieldsToToggle.forEach(f => {
        if (!f) return;

        if (disable) {
          // مقدار فعلی رو نگه داریم
          f.dataset.savedValue = f.value;  // یک بار ذخیره

          f.value = '';        // نمایش خالی
          f.disabled = true;   // غیر فعال
        } else {
          // بازگردوندن مقدار قبلی
          if (f.dataset.savedValue !== undefined) {
            f.value = f.dataset.savedValue;
          }
          f.disabled = false;  // فعال
        }
      });
    }
    giftuseCheckbox.addEventListener('change', toggleFields);
    toggleFields();
  }

  // در انتها: نمایش صفحه بدون چشمک
  document.getElementById('page-root')?.classList.remove('hide-until-ready');
});


function handleTransactionResponse(data) {
  if (data.success && data.operations && Array.isArray(data.operations)) {
    for (const op of data.operations) {
      const opType = (typeof op === "string") ? op : op.type;
      let msg = "";
      switch (opType) {
        case OP_SELL: msg = "فروش با موفقیت ثبت شد"; break;
        case OP_BUY:  msg = "خرید با موفقیت ثبت شد"; break;
        case OP_RCV:  msg = "دریافت وجه با موفقیت ثبت شد"; break;
        case OP_PAY:  msg = "پرداخت وجه با موفقیت ثبت شد"; break;
        case OP_USE:  msg = "مصرف شخصی/هدیه با موفقیت ثبت شد"; break;
        default: msg = "عملیات با موفقیت انجام شد";
      }
      notify('success', msg);
    }
    const form = document.getElementById('main-form');
    if (form) form.reset();
    // بعد از reset فرم، تاریخ را دوباره فارسی کن
    const dateDisplay = document.getElementById('id_date_shamsi_display');
    if (dateDisplay && typeof toFaDigits === 'function') {
      dateDisplay.value = toFaDigits(dateDisplay.value);
    }

    form.querySelectorAll('select').forEach(sel => {
      sel.selectedIndex = -1;  // هیچ گزینه‌ای انتخاب نشود
      sel.dispatchEvent(new Event('change'));
    
    // تنظیم دوباره نحوه پرداخت روی مقدار پیش‌فرض
    const paymentMethodSelect = document.getElementById('payment_method');
    paymentMethodSelect.value = paymentMethodSelect.options[0].value;
    paymentMethodSelect.dispatchEvent(new Event('change'));

  });
    if (typeof refreshRecent === 'function') { refreshRecent(); }
  }
  else {
    if (data.errors) {
      const errs = Object.entries(data.errors).map(([k,v])=>`${k}: ${v}`).join(' | ');
      notify('error', 'خطا در ثبت تراکنش: ' + errs);
    } else {
      notify('error', 'خطا در ثبت تراکنش');
    }
  }
}

document.getElementById('main-form').addEventListener('submit', function(e){
  e.preventDefault();
  const form = e.target;

  const dateShamsiDisplay = document.getElementById('id_date_shamsi_display');
  const dateShamsiHidden  = document.getElementById('id_date_shamsi');
  if (dateShamsiDisplay && dateShamsiHidden) {
      dateShamsiHidden.value = toEnDigits(dateShamsiDisplay.value);
  }

  const formData = new FormData(form);
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {'X-Requested-With': 'XMLHttpRequest'}
  })
  .then(r => r.json())
  .then(data => {
    if (data._debug) {
      for (const log of data._debug) console.log(log);
    }
    handleTransactionResponse(data);
  })
  .catch(err => console.error("❌ Fetch error:", err));
});
</script>
{% endblock %}
